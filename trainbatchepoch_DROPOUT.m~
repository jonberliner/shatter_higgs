function [net,out] = trainbatchepoch_DROPOUT(net,bIN,bTAR,lrate)
    
    [nPar, nInPer, nHidPer] = size(net.Wih);
    nHid = nPar * nHidPer;
    
    [nPer, nIn, nBatch] = size(bIN);
    [nPer, nOut, nBatch] = size(bTAR);
    
    
    nHidD2 = floor(nHid/2);
    nHidPerD2 = floor(nHidPer/2);
    hid = nan(nPer, nHidD2);
    hused = nan(nPar, nHidPerD2);
    ihused = nan(nHidD2);
    
    
    sig = @(x) 1./(1 + exp(-x)); % sigmoidal transfer function
    nonans = @(in) sum( isnan( in(:) ) ) == 0; % helper fcn
    
    
    for b = 1:nBatch

        in = squeeze(bIN(:, :, b));
        tar = squeeze(bTAR(:, :, b));
        
        %% CHOOSE DROPOUT NODES
        for p = 1:nPar
            hused(p, :) = randsample(nHidPer, nHidPerD2); % choose nodes
            ihused(p, :) = net.hid(p, hused(p, :)); % get shatterIDs
        end
        
        %% FORWARD PASS
        % net input to hidden
        for p = 1:nPar
            
            % filter2noes
            Wih0 = squeeze(net.Wih(P, :, husedp));
            
            in0 = in(:, net.in(p, :));

            hid(:, net.hid(p, hused(p, :))) = sig(in0 * Wih0);
            
        end
        
        assert(nonans(hid));
        
        % combine for hidden to out
        out = sig(hid * net.Who(ihused, :));

        %% BACKPROP
        % update ho
        dout = out.*(1 - out) .* (tar - out); % nPerxnOut .x nPerxnOut .x nPerxnOut
        dWho = (hid' * dout) / nPer ; % nHidxnPer x nPerxnOut

        net.Who(ihused, :) = net.Who(ihused, :) + lrate * dWho; % update DROPOUT nodes

        % update ih
        for p = 1:nPar
               
            % in2hid weights for dropout-selected units in partition p
            Wih0 = squeeze(net.Wih(P, :, hused(p, :)));
            
            % which hidden units used in this dropped
            ih0 = ihused(p, :);
            in0 = in(:, net.in(p, :));
            hid0 = hid(ih0);
            
            dhid0 = hid0 .* (1 - hid0) .* (dout * net.Who(ih0, :)'); % nPerxnHid .x nPerxnHid .x (nPerxnOut x nOutxnHid)
            dWih0 = (in0' * dhid0) / nPer ; % nInxnPer x nPerxnHid
            Wih0 = Wih0 + lrate .* dWih0;

            net.Wih(p, :, used) = Wih0;
        end
    end